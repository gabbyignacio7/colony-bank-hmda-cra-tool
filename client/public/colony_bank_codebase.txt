================================================================================
COLONY BANK HMDA/CRA ETL AUTOMATION TOOL - COMPLETE CODEBASE
================================================================================
Generated: $(date)
================================================================================

================================================================================
FILE: client/src/lib/etl-engine.ts
================================================================================
import { read, utils, writeFile } from 'xlsx';

export interface SbslRow {
  // Legacy fields
  ApplNumb?: string;
  'Last Name'?: string;
  'Loan Type'?: string;
  'Action Taken'?: string;
  'Loan Amount'?: number;
  'Note Date'?: string | number | Date;
  Revenue?: number;
  Affiliate?: string;
  Address?: string;
  City?: string;
  State?: string;
  Zip?: string;
  Comment?: string;
  
  // HMDA Test File Fields (from test data)
  Loan_Number?: string;
  Application_Date?: string | number | Date;
  Interest_Rate?: number;
  Loan_Term_Months?: number;
  Loan_Purpose_Code?: number;
  Property_Type_Code?: number;
  Loan_Type_Code?: number;
  Action_Taken_Code?: number;
  County_Code?: string;
  Census_Tract?: string;
  Borrower_Last_Name?: string;
  Borrower_First_Name?: string;
  Property_Street?: string;
  Property_City?: string;
  Property_State?: string;
  Property_Zip?: string;
  Income_Thousands?: number;
  Credit_Score?: number;
  Closing_Date?: string | number | Date;
  Applicant_Ethnicity?: number;
  Applicant_Race_1?: number;
  Applicant_Sex?: number;
  
  // Calculated Fields from Phase 2
  'Branch Name'?: string;
  'Branch'?: string;
  'Application Number'?: string;
  'Loan Term Years'?: number;
  'Customer Name'?: string;
  'Borrower Name Code'?: string;
  'Lender'?: string;
  'Lender Assistant'?: string;
  'Post Closer'?: string;
  'APR'?: string | number;
  'Rate Lock Date'?: string;
  'Rate Type'?: string;
  'Variable Term'?: string;
  'Loan Program'?: string;
  
  [key: string]: any;
}

export interface ValidationResult {
  rowIdx: number;
  applNumb: string;
  errors: string[];
}

// Mock Data for Demo (Updated with new fields)
export const MOCK_SBSL_DATA: SbslRow[] = [
  {
    ApplNumb: "2024-001",
    "Last Name": "Smith",
    "Loan Type": "Small Business",
    "Action Taken": "Originated",
    "Loan Amount": 75000,
    "Note Date": new Date().toISOString().split('T')[0],
    Revenue: 500000,
    Affiliate: "Main Branch",
    Address: "123 Main St",
    City: "Atlanta",
    State: "GA",
    Zip: "30301",
    "Branch": "001",
    "Branch Name": "Main Branch",
    "APR": "7.125",
    "Loan Term Years": 5
  },
  {
    ApplNumb: "2024-002",
    "Last Name": "Johnson",
    "Loan Type": "Commercial",
    "Action Taken": "Originated",
    "Loan Amount": 150000,
    "Note Date": "2023-12-15",
    Revenue: 1200000,
    Affiliate: "North Branch",
    Address: "456 Oak Rd",
    City: "Savannah",
    State: "GA",
    Zip: "31401",
    "Branch": "002",
    "Branch Name": "North Branch",
    "APR": "6.500",
    "Loan Term Years": 10
  },
];

export const fetchCsvFile = async (filename: string): Promise<SbslRow[]> => {
  try {
    const response = await fetch(`/sample_data/${filename}`);
    if (!response.ok) throw new Error(`Failed to fetch ${filename}`);
    const arrayBuffer = await response.arrayBuffer();
    const data = new Uint8Array(arrayBuffer);
    const workbook = read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    return utils.sheet_to_json(sheet) as SbslRow[];
  } catch (error) {
    console.error("Error fetching CSV:", error);
    throw error;
  }
};

// 128-column output format for CRA Wiz upload - MUST be defined before processFile uses it
export const CRA_WIZ_128_COLUMNS = [
  'BranchName', 'Branch', 'ApplNumb', 'LEI', 'ULI', 'LastName', 'FirstName',
  'Coa_LastName', 'Coa_FirstName', 'Lender', 'AA_Processor', 'LDP_PostCloser',
  'Error_Made_By', 'ApplDate', 'LoanType', 'Purpose', 'ConstructionMethod',
  'OccupancyType', 'LoanAmount', 'Preapproval', 'Action', 'ActionDate',
  'Address', 'City', 'State_abrv', 'Zip', 'County_5', 'Tract_11',
  'Ethnicity_1', 'Ethnicity_2', 'Ethnicity_3', 'Ethnicity_4', 'Ethnicity_5',
  'EthnicityOther', 'Coa_Ethnicity_1', 'Coa_Ethnicity_2', 'Coa_Ethnicity_3',
  'Coa_Ethnicity_4', 'Coa_Ethnicity_5', 'Coa_EthnicityOther',
  'Ethnicity_Determinant', 'Coa_Ethnicity_Determinant',
  'Race_1', 'Race_2', 'Race_3', 'Race_4', 'Race_5',
  'Race1_Other', 'Race27_Other', 'Race44_Other',
  'CoaRace_1', 'CoaRace_2', 'CoaRace_3', 'CoaRace_4', 'CoaRace_5',
  'CoaRace1_Other', 'CoaRace27_Other', 'CoaRace44_Other',
  'Race_Determinant', 'CoaRace_Determinant',
  'Sex', 'CoaSex', 'Sex_Determinant', 'CoaSex_Determinant',
  'Age', 'Coa_Age', 'Income', 'Purchaser', 'Rate_Spread',
  'HOEPA_Status', 'Lien_Status', 'CreditScore', 'Coa_CreditScore',
  'CreditModel', 'CreditModelOther', 'Coa_CreditModel', 'Coa_CreditModelOther',
  'Denial1', 'Denial2', 'Denial3', 'Denial4', 'DenialOther',
  'TotalLoanCosts', 'TotalPtsAndFees', 'OrigFees', 'DiscountPts', 'LenderCredts',
  'InterestRate', 'APR', 'Rate_Lock_Date', 'PPPTerm', 'DTIRatio', 'DSC', 'CLTV',
  'Loan_Term', 'Loan_Term_Months', 'IntroRatePeriod', 'BalloonPMT', 'IOPMT',
  'NegAM', 'NonAmortz', 'PropertyValue', 'MHSecPropType', 'MHLandPropInt',
  'TotalUnits', 'MFAHU', 'APPMethod', 'PayableInst', 'NMLSRID',
  'AUSystem1', 'AUSystem2', 'AUSystem3', 'AUSystem4', 'AUSystem5', 'AUSystemOther',
  'AUSResult1', 'AUSResult2', 'AUSResult3', 'AUSResult4', 'AUSResult5', 'AUSResultOther',
  'REVMTG', 'OpenLOC', 'BUSCML', 'RateType', 'Var_Term', 'LoanProgram', 'ProductType'
];

// Detect the best delimiter for a line of text
const detectDelimiter = (line: string): string => {
  const delimiters = ['~', '|', '\t', ','];
  let bestDelimiter = ',';
  let maxCount = 0;
  
  for (const delim of delimiters) {
    const regex = delim === '|' ? /\|/g : new RegExp(delim, 'g');
    const matches = line.match(regex);
    const count = matches ? matches.length : 0;
    if (count > maxCount) {
      maxCount = count;
      bestDelimiter = delim;
    }
  }
  
  return bestDelimiter;
};

export const processFile = async (file: File): Promise<any[]> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    // Handle text files - detect delimiter automatically
    if (file.name.endsWith('.txt')) {
      reader.onload = (e) => {
        try {
          const text = e.target?.result as string;
          const lines = text.split('\n').filter(line => line.trim());
          
          if (lines.length > 0) {
            // Check first few lines to detect delimiter
            const firstLine = lines[0];
            const secondLine = lines.length > 1 ? lines[1] : '';
            
            // Detect delimiter - check both first and second lines
            let delimiter = detectDelimiter(secondLine || firstLine);
            let skipRows = 0;
            let isLaserProFormat = false;
            
            // Check if first row is metadata (starts with "1|" for pipe or has Colony Bank)
            if (firstLine.includes('|') && (firstLine.startsWith('1|') || firstLine.includes('Colony Bank'))) {
              skipRows = 1;
              // The actual data rows likely use a different delimiter (tilde ~)
              if (secondLine) {
                delimiter = detectDelimiter(secondLine);
              }
              isLaserProFormat = true;
              console.log(`Detected LaserPro format: metadata row uses pipe, data uses "${delimiter}" delimiter`);
            } else {
              console.log(`Detected delimiter: "${delimiter === '\t' ? 'TAB' : delimiter}"`);
            }
            
            // For LaserPro format (metadata row + tilde/pipe delimited data)
            if (isLaserProFormat) {
              // Parse all data rows (skip metadata row 1)
              const dataLines = lines.slice(skipRows);
              const data = dataLines.map((line, idx) => {
                const values = line.split(delimiter);
                console.log(`Row ${idx + 1}: Split into ${values.length} columns using "${delimiter}" delimiter`);
                
                // Map positional fields to named fields based on detected column count
                // Create an object with all values mapped to column positions
                const row: any = {
                  _rowIndex: idx + skipRows + 1,
                  _columnCount: values.length,
                  _delimiter: delimiter,
                };
                
                // Map to 128-column format based on position
                // The actual column mapping based on LaserPro export format
                CRA_WIZ_128_COLUMNS.forEach((colName, i) => {
                  row[colName] = values[i]?.trim() || '';
                });
                
                return row;
              });
              
              console.log(`Parsed ${data.length} LaserPro rows with ${data[0]?._columnCount || 0} columns each`);
              resolve(data);
              return;
            }
            
            // Standard delimited file - split each line into columns
            const dataLines = lines.slice(skipRows);
            const data = dataLines.map((line, idx) => {
              const values = line.split(delimiter);
              const row: any = {
                _rowIndex: idx + 1,
                _columnCount: values.length,
              };
              
              // Map to 128-column format based on position
              CRA_WIZ_128_COLUMNS.forEach((colName, i) => {
                row[colName] = values[i]?.trim() || '';
              });
              
              return row;
            });
            
            if (data.length > 0) {
              console.log(`Parsed ${data.length} rows with ${data[0]?._columnCount || 0} columns from text file`);
              resolve(data);
              return;
            }
          }
          // Fallback if parsing fails
          console.log("Text file parsing failed, using sample data");
          resolve(MOCK_SBSL_DATA);
        } catch (error) {
          console.error("Error parsing text file:", error);
          resolve(MOCK_SBSL_DATA);
        }
      };
      reader.readAsText(file);
      return;
    }
    
    // Handle PDF files - return mock data for demo
    if (file.name.endsWith('.pdf')) {
       console.log("PDF file detected - would require PDF parsing library");
       resolve(MOCK_SBSL_DATA);
       return;
    }

    // Handle Excel/CSV files
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target?.result as ArrayBuffer);
        const workbook = read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        
        // Check if this looks like an Encompass file (has metadata rows)
        // Parse with range option to skip metadata rows if detected
        let jsonData = utils.sheet_to_json(sheet) as any[];
        
        // Detect Encompass format by checking first row for metadata patterns
        if (jsonData.length > 0) {
          const firstRow = jsonData[0];
          const firstRowKeys = Object.keys(firstRow);
          const firstValue = String(firstRow[firstRowKeys[0]] || '');
          
          // If first row looks like Encompass metadata, skip first 2 rows
          if (firstValue.includes('Encompass') || firstValue.includes('Report') || 
              firstRowKeys.some(k => k.includes('__EMPTY'))) {
            console.log('Detected Encompass format, skipping metadata rows');
            // Re-parse starting from row 3 (skip first 2 metadata rows)
            jsonData = utils.sheet_to_json(sheet, { range: 2 }) as any[];
          }
        }
        
        console.log(`Parsed ${jsonData.length} rows from Excel/CSV file`);
        resolve(jsonData);
      } catch (error) {
        console.error("Error parsing Excel/CSV file:", error);
        reject(error);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
};

// Transform data to 128-column CRA Wiz format
export const transformToCRAWizFormat = (data: SbslRow[]): any[] => {
  return data.map(row => {
    const output: any = {};
    
    // Map each column, looking for matching field names (case-insensitive)
    CRA_WIZ_128_COLUMNS.forEach(col => {
      // Try exact match first
      if (row[col] !== undefined) {
        output[col] = row[col];
        return;
      }
      
      // Try case-insensitive match
      const lowerCol = col.toLowerCase();
      const matchingKey = Object.keys(row).find(k => k.toLowerCase() === lowerCol);
      if (matchingKey) {
        output[col] = row[matchingKey];
        return;
      }
      
      // Try common field name variations
      const fieldMappings: Record<string, string[]> = {
        'BranchName': ['BranchName', 'Branch Name', 'Branch_Name'],
        'Branch': ['Branch', 'BranchNumb', 'BRANCHNUMB'],
        'ApplNumb': ['ApplNumb', 'ULI', 'Loan_Number', 'LoanNumber'],
        'LastName': ['LastName', 'Last Name', 'Borrower_Last_Name'],
        'FirstName': ['FirstName', 'First Name', 'Borrower_First_Name'],
        'LoanAmount': ['LoanAmount', 'Loan Amount', 'Loan_Amount'],
        'Address': ['Address', 'Property_Street', 'PropertyStreet'],
        'City': ['City', 'Property_City', 'PropertyCity'],
        'State_abrv': ['State_abrv', 'State', 'Property_State', 'PropertyState'],
        'Zip': ['Zip', 'Property_Zip', 'PropertyZip', 'ZipCode'],
        'InterestRate': ['InterestRate', 'Interest_Rate', 'Interest Rate'],
        'Income': ['Income', 'Income_Thousands'],
        'CreditScore': ['CreditScore', 'Credit_Score'],
        'Loan_Term_Months': ['Loan_Term_Months', 'LoanTermMonths', 'Term'],
      };
      
      const mappings = fieldMappings[col];
      if (mappings) {
        for (const alt of mappings) {
          if (row[alt] !== undefined) {
            output[col] = row[alt];
            return;
          }
        }
      }
      
      // Default to empty string
      output[col] = '';
    });
    
    return output;
  });
};

// Export to CRA Wiz 128-column format
export const exportCRAWizFormat = (data: SbslRow[], filename?: string): void => {
  const transformedData = transformToCRAWizFormat(data);
  const monthYear = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  const defaultFilename = `CRA_Wiz_Upload_${monthYear.replace(' ', '_')}.xlsx`;
  
  const ws = utils.json_to_sheet(transformedData, { header: CRA_WIZ_128_COLUMNS });
  const wb = utils.book_new();
  utils.book_append_sheet(wb, ws, "CRA Data");
  
  writeFile(wb, filename || defaultFilename);
};

export const filterByCurrentMonth = (data: SbslRow[]): { filtered: SbslRow[], count: number } => {
  const currentMonth = new Date().getMonth();
  const currentYear = new Date().getFullYear();
  
  const filtered = data.filter(row => {
    // Check multiple possible date fields
    const dateVal = row['Note Date'] || row.Application_Date || row['Application_Date'];
    
    // For demo: if no date field exists, keep the record
    if (!dateVal) return true;
    
    const date = new Date(dateVal);
    // For demo: if date is invalid, keep the record
    if (isNaN(date.getTime())) return true;

    // Accept loans from the last 12 months for demo purposes
    const monthsAgo = (currentYear - date.getFullYear()) * 12 + (currentMonth - date.getMonth());
    return monthsAgo >= 0 && monthsAgo <= 12;
  });
  
  return { filtered, count: filtered.length };
};

// Phase 2 Step 1: Transformation Logic
export const transformEncompassData = (data: SbslRow[]): SbslRow[] => {
  return data.map(row => {
    const newRow = { ...row };
    
    // Calculate Branch (First 3 of Loan Number/ApplNumb)
    if (newRow.ApplNumb) {
      newRow['Branch'] = newRow.ApplNumb.substring(0, 3);
    }
    
    // Calculate Loan Term Years
    if (newRow['Loan Term in Months']) {
      newRow['Loan Term Years'] = Number(newRow['Loan Term in Months']) / 12;
    }
    
    return newRow;
  });
};

// Phase 2 Step 2: VLOOKUP Simulation
export const mergeSupplementalData = (mainData: SbslRow[], suppData: SbslRow[]): SbslRow[] => {
  // Create lookup map using either Loan_Number (HMDA) or ApplNumb (legacy)
  const suppMap = new Map(
    suppData.map(row => [row.Loan_Number || row.ApplNumb, row])
  );
  
  return mainData.map(row => {
    const joinKey = row.Loan_Number || row.ApplNumb;
    const supp = suppMap.get(joinKey);
    if (!supp) return row;
    
    return {
      ...row,
      // Merge HMDA fields
      Applicant_Ethnicity: supp.Applicant_Ethnicity,
      Applicant_Race_1: supp.Applicant_Race_1,
      Applicant_Sex: supp.Applicant_Sex,
      Income_Thousands: supp.Income_Thousands,
      Credit_Score: supp.Credit_Score,
      Borrower_Last_Name: supp.Borrower_Last_Name,
      Borrower_First_Name: supp.Borrower_First_Name,
      Property_Street: supp.Property_Street,
      Property_City: supp.Property_City,
      Property_State: supp.Property_State,
      Property_Zip: supp.Property_Zip,
      // Legacy fields
      'Customer Name': supp['Customer Name'],
      'Borrower Name': supp['Borrower Name'],
      'Lender': supp['Lender'],
      'APR': supp['APR'] || supp.Interest_Rate,
      'Rate Type': supp['Rate Type'] === 'ARM' ? '2' : '1',
    };
  });
};

// Phase 2 Step 3: Cleaning
export const cleanAndFormatData = (data: SbslRow[]): SbslRow[] => {
  const branchMap: Record<string, string> = {
    '001': 'Main Branch',
    '002': 'North Branch',
    '003': 'West Branch'
  };

  return data.map(row => {
    const newRow = { ...row };
    
    // Branch Name Mapping
    if (newRow.Branch && branchMap[newRow.Branch]) {
      newRow['Branch Name'] = branchMap[newRow.Branch];
    }
    
    // APR Formatting (Remove trailing zeros)
    if (newRow.APR) {
      newRow.APR = String(newRow.APR).replace(/0+$/, '').replace(/\.$/, '');
    }
    
    // County Zero Padding (5 digits)
    if (newRow['County Code']) {
      newRow['County Code'] = String(newRow['County Code']).padStart(5, '0');
    }
    
    // Tract Zero Padding (11 digits)
    if (newRow['Tract']) {
      newRow['Tract'] = String(newRow['Tract']).padStart(11, '0');
    }
    
    return newRow;
  });
};

export const validateData = (data: SbslRow[]): ValidationResult[] => {
  const results: ValidationResult[] = [];
  
  data.forEach((row, idx) => {
    const errors: string[] = [];
    const loanId = row.Loan_Number || row.ApplNumb || 'N/A';
    
    // HMDA Required Fields
    if (row.Loan_Number) {
      // HMDA data validation
      if (!row.Loan_Number) errors.push("Missing Loan_Number");
      if (!row.Application_Date && !row['Note Date']) errors.push("Missing Application_Date");
      if (!row.Loan_Amount && !row['Loan Amount']) errors.push("Missing Loan_Amount");
      
      // Loan Amount validation
      const loanAmount = Number(row.Loan_Amount || row['Loan Amount']);
      if (isNaN(loanAmount) || loanAmount <= 0) errors.push("Loan Amount must be positive");
      
      // Interest Rate validation (0-20%, max 3 decimals)
      if (row.Interest_Rate || row['Interest Rate']) {
        const rate = Number(row.Interest_Rate || row['Interest Rate']);
        if (rate < 0 || rate > 20) errors.push("Interest Rate out of bounds (0-20%)");
        const rateStr = String(rate);
        if (rateStr.includes('.') && rateStr.split('.')[1].length > 3) {
          errors.push("Interest Rate max 3 decimal places");
        }
      }
      
      // Census Tract Format validation (##.## or ####.##)
      if (row.Census_Tract) {
        const tract = String(row.Census_Tract);
        if (!/^\d{2,4}\.\d{2}$/.test(tract)) {
          errors.push("Census Tract must be ##.## or ####.##");
        }
      }
      
      // Income validation (1-9999 thousands)
      if (row.Income_Thousands) {
        const income = Number(row.Income_Thousands);
        if (income < 1 || income > 9999) {
          errors.push("Income must be 1-9999 (thousands)");
        }
      }
      
      // Action Taken Code validation
      if (row.Action_Taken_Code) {
        const action = Number(row.Action_Taken_Code);
        if (![1, 2, 3, 4, 5, 6, 7, 8].includes(action)) {
          errors.push("Invalid Action Taken Code");
        }
      }
      
      // Property State validation
      if (row.Property_State) {
        if (String(row.Property_State).trim().length !== 2) {
          errors.push("State must be 2-letter code");
        }
      }
    } else {
      // Legacy validation
      const required = ['ApplNumb', 'Last Name', 'Loan Amount', 'Note Date'];
      required.forEach(field => {
        if (!row[field]) errors.push(`Missing ${field}`);
      });
      
      const loanAmount = Number(row['Loan Amount']);
      if (isNaN(loanAmount) || loanAmount <= 0) errors.push("Loan Amount must be positive");
      
      if (row['State'] && String(row['State']).trim().length !== 2) errors.push("State must be 2-letter code");
      
      if (row['Zip']) {
        const zipStr = String(row['Zip']).trim();
        if (zipStr.length < 5) errors.push("Invalid ZIP code");
        if (/[a-zA-Z]/.test(zipStr)) errors.push("ZIP contains letters");
      }
    }

    if (errors.length > 0) {
      results.push({
        rowIdx: idx + 2,
        applNumb: loanId,
        errors
      });
    }
  });
  
  return results;
};

// Auto-correct fixable validation errors
export const autoCorrectData = (data: SbslRow[]): SbslRow[] => {
  return data.map(row => {
    const corrected = { ...row };
    
    // Fix Census Tract formatting (convert to ##.## or ####.##)
    if (corrected.Census_Tract) {
      let tract = String(corrected.Census_Tract).replace(/[^\d.]/g, '');
      // If it doesn't have decimal, try to format it
      if (!tract.includes('.')) {
        if (tract.length >= 4) {
          tract = tract.slice(0, -2) + '.' + tract.slice(-2);
        }
      }
      // Ensure proper format
      const parts = tract.split('.');
      if (parts.length === 2) {
        const whole = parts[0].padStart(2, '0');
        const decimal = parts[1].padEnd(2, '0').slice(0, 2);
        corrected.Census_Tract = `${whole}.${decimal}`;
      }
    }
    
    // Fix Interest Rate (max 3 decimals, ensure in range)
    if (corrected.Interest_Rate || corrected['Interest Rate']) {
      let rate = Number(corrected.Interest_Rate || corrected['Interest Rate']);
      // Round to 3 decimals
      rate = Math.round(rate * 1000) / 1000;
      // Clamp to valid range if slightly out of bounds
      if (rate > 20 && rate < 21) rate = 20.0;
      if (rate < 0) rate = 0;
      corrected.Interest_Rate = rate;
      corrected['Interest Rate'] = rate;
    }
    
    // Fix APR formatting
    if (corrected.APR || corrected['APR']) {
      let apr = String(corrected.APR || corrected['APR']);
      // Remove trailing zeros and % sign
      apr = apr.replace('%', '').trim();
      const aprNum = parseFloat(apr);
      if (!isNaN(aprNum)) {
        corrected.APR = Math.round(aprNum * 1000) / 1000;
        corrected['APR'] = corrected.APR;
      }
    }
    
    // Trim whitespace from text fields
    if (corrected.Property_State) {
      corrected.Property_State = String(corrected.Property_State).trim().toUpperCase().slice(0, 2);
    }
    if (corrected.State) {
      corrected.State = String(corrected.State).trim().toUpperCase().slice(0, 2);
    }
    
    // Fix Income (clamp to valid range if close)
    if (corrected.Income_Thousands) {
      let income = Number(corrected.Income_Thousands);
      if (income > 9999 && income < 10100) income = 9999;
      if (income < 1 && income > 0) income = 1;
      corrected.Income_Thousands = income;
    }
    
    return corrected;
  });
};

export const generateSummaryStats = (data: SbslRow[]) => {
  const totalLoanAmount = data.reduce((sum, row) => {
    // Check both HMDA and legacy field names
    const amount = Number(row.Loan_Amount || row['Loan Amount']) || 0;
    return sum + amount;
  }, 0);
  
  const totalTerm = data.reduce((sum, row) => {
    const termYears = Number(row['Loan Term Years']) || (row.Loan_Term_Months ? Number(row.Loan_Term_Months) / 12 : 0) || 0;
    return sum + termYears;
  }, 0);
  
  return {
    totalRecords: data.length,
    totalLoanAmount,
    avgLoanAmount: data.length ? totalLoanAmount / data.length : 0,
    avgTerm: data.length ? totalTerm / data.length : 0
  };
};

================================================================================
FILE: client/src/lib/cra-wiz-transform.ts
================================================================================
import { read, utils, writeFile } from 'xlsx';

// Embedded Branch List (48 branches)
export const BRANCH_LIST: Record<string, string> = {
  '101': 'Columbus',
  '103': 'Leesburg',
  '104': 'Savannah Hwy 17',
  '107': 'Savannah Hodgson',
  '108': 'Centerville',
  '109': 'Warner Robins',
  '110': 'Valdosta',
  '114': 'Statesboro',
  '116': 'LaGrange',
  '125': 'Albany NW',
  '127': 'Thomaston',
  '129': 'Manchester',
  '131': 'Fayetteville',
  '134': 'Cedartown',
  '136': 'Rockmart',
  '137': 'Chickamauga',
  '201': 'Rochelle',
  '203': 'Cordele',
  '204': 'Ashburn',
  '205': 'Moultrie',
  '206': 'Tifton',
  '207': 'Sylvester',
  '208': 'Fitzgerald',
  '209': 'Douglas',
  '210': 'Baxley',
  '211': 'Waycross',
  '212': 'Alma',
  '213': 'Albany Westover',
  '301': 'Quitman',
  '302': 'Thomasville',
  '303': 'Cairo',
  '304': 'Camilla',
  '305': 'Blakely',
  '306': 'Donalsonville',
  '307': 'Bainbridge',
  '308': 'Albany Dawson',
  '401': 'Dothan',
  '402': 'Valdosta Mortgage',
  '403': 'Gulf Shores',
  '404': 'Tallahassee Mortgage',
  '406': 'Albany Mortgage',
  '407': 'Tifton Mortgage',
  '408': 'Valdosta Mall',
  '410': 'Homerville',
  '411': 'Panama City',
  '414': 'Perry',
  '415': 'Tallahassee Mahan',
  '416': 'Tallahassee'
};

// Exact 125-column output order
export const OUTPUT_COLUMNS = [
  'BRANCHNAME',
  'BRANCHNUMB',
  'LEI',
  'ULI',
  'LASTNAME',
  'FIRSTNAME',
  'CLASTNAME',
  'CFIRSTNAME',
  'LENDER',
  'AA_LOANPROCESSOR',
  'LDP_POSTCLOSER',
  'ErrorMadeBy',
  'APPLDATE',
  'LOANTYPE',
  'PURPOSE',
  'CONSTRUCTIONMETHOD',
  'OCCUPANCYTYPE',
  'LOANAMOUNTINDOLLARS',
  'PREAPPROVAL',
  'ACTION',
  'ACTIONDATE',
  'ADDRESS',
  'CITY',
  'STATE_ABRV',
  'ZIP',
  'COUNTY_5',
  'TRACT_11',
  'ETHNICITY_1',
  'ETHNICITY_2',
  'ETHNICITY_3',
  'ETHNICITY_4',
  'ETHNICITY_5',
  'ETHNICITYOTHER',
  'COA_ETHNICITY_1',
  'COA_ETHNICITY_2',
  'COA_ETHNICITY_3',
  'COA_ETHNICITY_4',
  'COA_ETHNICITY_5',
  'COA_ETHNICITYOTHER',
  'ETHNICITY_DETERMINANT',
  'COA_ETHNICITY_DETERMINANT',
  'RACE_1',
  'RACE_2',
  'RACE_3',
  'RACE_4',
  'RACE_5',
  'RACE1_OTHER',
  'RACE27_OTHER',
  'RACE44_OTHER',
  'COARACE_1',
  'COARACE_2',
  'COARACE_3',
  'COARACE_4',
  'COARACE_5',
  'COARACE1_OTHER',
  'COARACE27_OTHER',
  'COARACE44_OTHER',
  'RACE_DETERMINANT',
  'COARACE_DETERMINANT',
  'SEX',
  'COASEX',
  'SEX_DETERMINANT',
  'COASEX_DETERMINANT',
  'AGE',
  'COA_AGE',
  'INCOME',
  'PURCHASER',
  'RATE_SPREAD',
  'HOEPA_STATUS',
  'LIEN_STATUS',
  'CREDITSCORE',
  'COA_CREDITSCORE',
  'CREDITMODEL',
  'CREDITMODELOTHER',
  'COA_CREDITMODEL',
  'COA_CREDITMODELOTHER',
  'DENIAL1',
  'DENIAL2',
  'DENIAL3',
  'DENIAL4',
  'DENIALOTHER',
  'TOTALLOANCOSTS',
  'TOTALPTSANDFEES',
  'ORIGFEES',
  'DISCOUNTPTS',
  'LENDERCREDTS',
  'INTERESTRATE',
  'APR',
  'RATE_LOCK_DATE',
  'PPPTERM',
  'DTIRATIO',
  'DSC',
  'CLTV',
  'LOAN_TERM',
  'LOAN_TERM_MONTHS',
  'INTRORATEPERIOD',
  'BALLOONPMT',
  'IOPMT',
  'NEGAM',
  'NONAMORTZ',
  'PROPERTYVALUE',
  'MHSECPROPTYPE',
  'MHLANDPROPINT',
  'TOTALUNITS',
  'MFAHU',
  'APPMETHOD',
  'PAYABLEINST',
  'NMLSRID',
  'AUSYSTEM1',
  'AUSYSTEM2',
  'AUSYSTEM3',
  'AUSYSTEM4',
  'AUSYSTEM5',
  'AUSYSTEMOTHER',
  'AUSRESULT1',
  'AUSRESULT2',
  'AUSRESULT3',
  'AUSRESULT4',
  'AUSRESULT5',
  'AUSRESULTOTHER',
  'REVMTG',
  'OPENLOC',
  'BUSCML',
  'RATETYPE',
  'VAR_TERM'
];

export interface CRAWizRow {
  [key: string]: any;
}

// Date columns that need Excel serial number to M/D/YY conversion
const DATE_COLUMNS = ['APPLDATE', 'ACTIONDATE', 'RATE_LOCK_DATE'];

// Convert Excel serial number to M/D/YY format
const excelDateToString = (serial: any): string => {
  if (!serial || isNaN(serial)) return serial;
  const numSerial = Number(serial);
  if (numSerial < 1000) return serial; // Not a valid Excel date serial
  const date = new Date((numSerial - 25569) * 86400 * 1000);
  return `${date.getMonth() + 1}/${date.getDate()}/${String(date.getFullYear()).slice(-2)}`;
};

export interface TransformResult {
  data: CRAWizRow[];
  inputColumns: number;
  outputColumns: number;
  rowCount: number;
  branchMatchCount: number;
  branchMissCount: number;
}

export const parseCRAWizFile = async (file: File): Promise<CRAWizRow[]> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target?.result as ArrayBuffer);
        const workbook = read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const jsonData = utils.sheet_to_json(sheet) as CRAWizRow[];
        console.log(`Parsed CRA Wiz file: ${jsonData.length} rows, ${Object.keys(jsonData[0] || {}).length} columns`);
        resolve(jsonData);
      } catch (error) {
        console.error("Error parsing CRA Wiz file:", error);
        reject(error);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
};

export const transformCRAWizExport = (
  inputData: CRAWizRow[], 
  customBranchList?: Record<string, string>
): TransformResult => {
  const branchLookup = customBranchList || BRANCH_LIST;
  let branchMatchCount = 0;
  let branchMissCount = 0;
  
  const transformedData = inputData.map(row => {
    // Use BRANCHNAME from input file first, only fallback to VLOOKUP if blank
    const inputBranchName = row.BRANCHNAME ? String(row.BRANCHNAME).trim() : '';
    const branchNum = String(row.BRANCHNUMB || '').trim();
    const lookupBranchName = branchLookup[branchNum] || '';
    
    // Preserve original BRANCHNAME, use lookup only as fallback
    const branchName = inputBranchName || lookupBranchName;
    
    if (branchName) {
      branchMatchCount++;
    } else {
      branchMissCount++;
    }
    
    // Build output row with exact 125-column order
    const outputRow: CRAWizRow = {};
    
    OUTPUT_COLUMNS.forEach(col => {
      if (col === 'BRANCHNAME') {
        outputRow[col] = branchName;
      } else if (col === 'ErrorMadeBy' || col === 'DSC') {
        outputRow[col] = '';
      } else if (DATE_COLUMNS.includes(col)) {
        // Convert Excel serial dates to M/D/YY format
        outputRow[col] = excelDateToString(row[col]);
      } else {
        outputRow[col] = row[col] !== undefined ? row[col] : '';
      }
    });
    
    return outputRow;
  });
  
  return {
    data: transformedData,
    inputColumns: Object.keys(inputData[0] || {}).length,
    outputColumns: OUTPUT_COLUMNS.length,
    rowCount: transformedData.length,
    branchMatchCount,
    branchMissCount
  };
};

export const exportWorkItemFile = (data: CRAWizRow[], filename?: string) => {
  const monthYear = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  const defaultFilename = `HMDA_WorkItem_${monthYear.replace(' ', '_')}.csv`;
  
  const ws = utils.json_to_sheet(data, { header: OUTPUT_COLUMNS });
  const wb = utils.book_new();
  utils.book_append_sheet(wb, ws, "Work Items");
  
  writeFile(wb, filename || defaultFilename);
};

export const exportTransformSummary = (result: TransformResult) => {
  const monthYear = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  const filename = `HMDA_Transform_Summary_${monthYear.replace(' ', '_')}.xlsx`;
  
  const summaryData = [{
    'Transformation Date': new Date().toLocaleString(),
    'Input Columns': result.inputColumns,
    'Output Columns': result.outputColumns,
    'Total Rows': result.rowCount,
    'Branch Matches': result.branchMatchCount,
    'Branch Misses': result.branchMissCount,
    'New Columns Added': 'ErrorMadeBy, DSC',
    'Columns Removed': result.inputColumns - result.outputColumns + 2
  }];
  
  const ws = utils.json_to_sheet(summaryData);
  const wb = utils.book_new();
  utils.book_append_sheet(wb, ws, "Summary");
  
  // Add branch reference sheet
  const branchData = Object.entries(BRANCH_LIST).map(([num, name]) => ({
    'Branch Number': num,
    'Branch Name': name
  }));
  const branchWs = utils.json_to_sheet(branchData);
  utils.book_append_sheet(wb, branchWs, "Branch Reference");
  
  writeFile(wb, filename);
};

================================================================================
FILE: client/src/lib/diff-engine.ts
================================================================================
import { SbslRow } from "./etl-engine";

export interface DiffResult {
  identical: boolean;
  diffCount: number;
  differences: Difference[];
  actualRows: number;
  expectedRows: number;
  rowDiff: number;
}

export interface Difference {
  type: string;
  column?: string;
  rowsAffected?: number;
  sampleActual?: string;
  sampleExpected?: string;
  columns?: string;
}

export const compareDataframes = (actual: SbslRow[], expected: SbslRow[]): DiffResult => {
  const result: DiffResult = {
    identical: false,
    diffCount: 0,
    differences: [],
    actualRows: actual.length,
    expectedRows: expected.length,
    rowDiff: Math.abs(actual.length - expected.length)
  };

  // Compare row counts
  if (actual.length !== expected.length) {
    result.differences.push({
      type: 'Row Count',
      sampleActual: String(actual.length),
      sampleExpected: String(expected.length)
    });
  }

  if (actual.length === 0 || expected.length === 0) {
    // If one is empty but not both, we already logged row count diff.
    // If both empty, identical.
    if (actual.length === 0 && expected.length === 0) {
       result.identical = true;
    }
    result.diffCount = result.differences.length;
    return result;
  }

  // Compare columns (using first row as schema source for simplicity)
  const actualCols = Object.keys(actual[0]);
  const expectedCols = Object.keys(expected[0]);
  
  const missingInActual = expectedCols.filter(c => !actualCols.includes(c));
  const extraInActual = actualCols.filter(c => !expectedCols.includes(c));

  if (missingInActual.length > 0) {
    result.differences.push({
      type: 'Missing Columns in Actual',
      columns: missingInActual.join(', ')
    });
  }
  
  if (extraInActual.length > 0) {
    result.differences.push({
      type: 'Extra Columns in Actual',
      columns: extraInActual.join(', ')
    });
  }

  // Compare Values (Basic check on first 100 rows to save perf)
  const commonCols = actualCols.filter(c => expectedCols.includes(c));
  const rowsToCompare = Math.min(actual.length, expected.length);
  
  for (const col of commonCols) {
    let diffCount = 0;
    let sampleAct = '';
    let sampleExp = '';
    
    for (let i = 0; i < rowsToCompare; i++) {
      if (String(actual[i][col]) !== String(expected[i][col])) {
        diffCount++;
        if (!sampleAct) {
          sampleAct = String(actual[i][col]);
          sampleExp = String(expected[i][col]);
        }
      }
    }
    
    if (diffCount > 0) {
      result.differences.push({
        type: 'Value Difference',
        column: col,
        rowsAffected: diffCount,
        sampleActual: sampleAct,
        sampleExpected: sampleExp
      });
    }
  }

  result.diffCount = result.differences.length;
  result.identical = result.diffCount === 0;
  
  return result;
};

================================================================================
FILE: client/src/pages/dashboard.tsx
================================================================================
import { useState, useEffect } from 'react';
import { utils, writeFile } from 'xlsx';
import { FileUpload } from '@/components/file-upload';
import { MultiFileUpload } from '@/components/multi-file-upload';
import { PasswordGate } from '@/components/password-gate';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { 
  Play, 
  FileText, 
  CheckCircle2, 
  AlertTriangle, 
  Download, 
  Loader2, 
  Database, 
  LayoutDashboard,
  Search,
  Filter,
  Trash2,
  ArrowRight,
  ChevronRight,
  FlaskConical,
  ShieldCheck,
  Activity,
  FileDiff,
  BookOpen,
  Video,
  FileScan,
  Printer,
  Share2,
  Copy,
  Check
} from 'lucide-react';
import { Progress } from '@/components/ui/progress';
import { 
  processFile, 
  fetchCsvFile,
  MOCK_SBSL_DATA, 
  filterByCurrentMonth, 
  validateData, 
  generateSummaryStats,
  transformEncompassData,
  cleanAndFormatData,
  mergeSupplementalData,
  exportCRAWizFormat,
  CRA_WIZ_128_COLUMNS,
  type SbslRow,
  type ValidationResult
} from '@/lib/etl-engine';
import { compareDataframes, type DiffResult } from '@/lib/diff-engine';
import { 
  parseCRAWizFile, 
  transformCRAWizExport, 
  exportWorkItemFile, 
  exportTransformSummary,
  BRANCH_LIST,
  type CRAWizRow,
  type TransformResult
} from '@/lib/cra-wiz-transform';
import { useToast } from '@/hooks/use-toast';
import { cn } from '@/lib/utils';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { TutorialVideo } from '@/components/tutorial-video';

export default function Dashboard() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const { toast } = useToast();
  const [activeTab, setActiveTab] = useState('upload');
  const [logs, setLogs] = useState<string[]>([]);
  const [isProcessing, setIsProcessing] = useState(false);
  
  // State
  const [files, setFiles] = useState<{
    laserPro: File | null, 
    encompass: File | null, 
    supp: File | null, 
    expected: File | null, 
    stress: File[]
  }>({ 
    laserPro: null, 
    encompass: null,
    supp: null,
    expected: null,
    stress: [] 
  });
  
  const [documentFiles, setDocumentFiles] = useState<File[]>([]);
  
  const [rawData, setRawData] = useState<SbslRow[]>([]);
  const [processedData, setProcessedData] = useState<SbslRow[]>([]);
  const [validationErrors, setValidationErrors] = useState<ValidationResult[]>([]);
  const [stats, setStats] = useState<any>(null);
  const [currentScenario, setCurrentScenario] = useState<string>("");
  
  // Diff State
  const [diffResult, setDiffResult] = useState<DiffResult | null>(null);
  
  // Stress Test State
  const [stressResults, setStressResults] = useState<any[]>([]);
  const [stressStats, setStressStats] = useState({
    filesProcessed: 0,
    successRate: "0/0",
    avgTime: 0,
    totalRows: 0
  });

  // Phase 3: CRA Wiz Post-Processing State
  const [craWizFile, setCraWizFile] = useState<File | null>(null);
  const [craWizData, setCraWizData] = useState<CRAWizRow[]>([]);
  const [phase3Result, setPhase3Result] = useState<TransformResult | null>(null);
  const [isPhase3Processing, setIsPhase3Processing] = useState(false);

  // Progress Tracking State
  const [progress, setProgress] = useState(0);
  const [progressStep, setProgressStep] = useState('');
  const [copied, setCopied] = useState(false);

  const addLog = (msg: string) => {
    setLogs(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${msg}`]);
  };

  const handleFileUpload = async (type: 'laserPro' | 'encompass' | 'supp' | 'expected', file: File) => {
    setFiles(prev => ({ ...prev, [type]: file }));
    
    try {
      const data = await processFile(file);
      
      if (type === 'encompass' || type === 'laserPro') {
        // Primary data sources
        setRawData(data as SbslRow[]);
        addLog(`Loaded ${type.toUpperCase()} file: ${file.name} (${data.length} rows)`);
        toast({ title: "File Loaded", description: `Successfully loaded ${data.length} records from ${file.name}` });
        setCurrentScenario("Custom Upload");
      } else {
        addLog(`Loaded ${type.toUpperCase()} file: ${file.name}`);
        toast({ title: "File Loaded", description: `${file.name} ready for processing` });
      }
    } catch (e) {
      addLog(`Error parsing file ${file.name}: ${e}`);
      toast({ title: "Error", description: `Failed to parse ${file.name}`, variant: "destructive" });
    }
  };

  const handleDocumentFilesUpload = (newFiles: File[]) => {
    setDocumentFiles(prev => [...prev, ...newFiles]);
    toast({ 
      title: "Documents Uploaded", 
      description: `Added ${newFiles.length} document${newFiles.length !== 1 ? 's' : ''} for processing.` 
    });
  };

  const handleRemoveDocumentFile = (index: number) => {
    setDocumentFiles(prev => prev.filter((_, i) => i !== index));
  };

  const runEtlProcess = async () => {
    setIsProcessing(true);
    setActiveTab('process');
    setLogs([]); 
    addLog("Starting Comprehensive ETL Process...");
    
    // Check if we have uploaded data
    if (rawData.length === 0 && !files.encompass && !files.laserPro) {
      addLog("No files uploaded. Using sample data for demonstration...");
      toast({ 
        title: "Using Sample Data", 
        description: "Upload files to process your own data", 
        variant: "default" 
      });
    }
    
    await new Promise(r => setTimeout(r, 500));
    
    // Step 1: Filter
    const currentMonth = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    addLog(`Phase 1: Filtering by current month (${currentMonth})...`);
    let currentData = rawData.length > 0 ? rawData : MOCK_SBSL_DATA;
    const { filtered, count } = filterByCurrentMonth(currentData);
    addLog(`Filtered: Kept ${count} records out of ${currentData.length} total.`);

    await new Promise(r => setTimeout(r, 500));

    // Step 2: Transformation
    addLog("Phase 2: Transforming Encompass Data...");
    addLog("   - Calculating Branch Codes");
    addLog("   - Deriving Application Numbers");
    addLog("   - Converting Loan Terms (Months -> Years)");
    let transformed = transformEncompassData(filtered);
    
    await new Promise(r => setTimeout(r, 500));

    // Step 3: VLOOKUP Merge
    addLog("Phase 2 (Step 2): Merging Supplemental Data...");
    // Simulate merge with self for demo if no supp file
    transformed = mergeSupplementalData(transformed, transformed);
    addLog("   - Merged Customer Names");
    addLog("   - Merged Borrower Data");
    addLog("   - Merged APR and Rate Types");

    await new Promise(r => setTimeout(r, 500));

    // Step 4: Cleaning
    addLog("Phase 2 (Step 3): Cleaning & Formatting...");
    addLog("   - Formatting APRs (removing trailing zeros)");
    addLog("   - Padding County Codes (5 digits)");
    addLog("   - Padding Tract Numbers (11 digits)");
    const cleaned = cleanAndFormatData(transformed);

    await new Promise(r => setTimeout(r, 500));

    // Step 5: Validation (CRA Wiz Simulation)
    addLog("Phase 3: Simulating CRA Wiz Validation...");
    const errors = validateData(cleaned);
    setValidationErrors(errors);
    addLog(`Validation complete: Found ${errors.length} issues.`);
    
    // Stats
    const summary = generateSummaryStats(cleaned);
    setStats(summary);
    
    setProcessedData(cleaned);
    setIsProcessing(false);
    addLog("ETL Process Complete.");
    
    // Log audit trail
    try {
      await fetch('/api/audit/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: 'System User',
          filesProcessed: (files.laserPro ? 1 : 0) + (files.encompass ? 1 : 0) + (files.supp ? 1 : 0),
          recordsProcessed: cleaned.length,
          validationErrors: errors.length,
          phase: 'Complete ETL Pipeline'
        })
      });
    } catch (err) {
      console.error('Failed to log audit trail:', err);
    }
    
    if (errors.length > 0) {
      toast({ title: "Validation Issues Found", description: `Found ${errors.length} records requiring attention.`, variant: "destructive" });
    } else {
      toast({ title: "Success", description: "Data processed successfully." });
    }
    
    setTimeout(() => setActiveTab('review'), 500);
  };

  const downloadMailMerge = () => {
    if (processedData.length === 0) {
      toast({ title: "No Data", description: "Run automation first to generate data", variant: "destructive" });
      return;
    }

    try {
      const monthYear = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      const filename = `HMDA_Scrub_Data_${monthYear.replace(' ', '_')}.xlsx`;
      
      // Generate Excel file with processed data
      const ws = utils.json_to_sheet(processedData);
      const wb = utils.book_new();
      utils.book_append_sheet(wb, ws, "Merge Data");
      
      writeFile(wb, filename);
      
      toast({ 
        title: "Export Complete", 
        description: `Downloaded ${filename} with ${processedData.length} records` 
      });
    } catch (error) {
      toast({ 
        title: "Export Failed", 
        description: "Error creating Excel file", 
        variant: "destructive" 
      });
    }
  };

  const downloadCRAWiz = () => {
    if (processedData.length === 0) {
      toast({ title: "No Data", description: "Run automation first to generate data", variant: "destructive" });
      return;
    }

    try {
      // Use the new 128-column CRA Wiz export format
      exportCRAWizFormat(processedData);
      
      toast({ 
        title: "CRA Export Complete", 
        description: `Downloaded ${CRA_WIZ_128_COLUMNS.length}-column CRA Wiz file with ${processedData.length} records` 
      });
    } catch (error) {
      toast({ 
        title: "Export Failed", 
        description: "Error creating CRA file", 
        variant: "destructive" 
      });
    }
  };

  const downloadValidationReport = () => {
    if (validationErrors.length === 0) {
      toast({ title: "No Errors", description: "All records passed validation!" });
      return;
    }

    try {
      const monthYear = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      const filename = `Validation_Errors_${monthYear.replace(' ', '_')}.xlsx`;
      
      // Format validation errors for export
      const errorData = validationErrors.map(err => ({
        'Row #': err.rowIdx,
        'Loan Number': err.applNumb,
        'Errors': err.errors.join('; ')
      }));
      
      const ws = utils.json_to_sheet(errorData);
      const wb = utils.book_new();
      utils.book_append_sheet(wb, ws, "Validation Errors");
      
      writeFile(wb, filename);
      
      toast({ 
        title: "Error Report Downloaded", 
        description: `${validationErrors.length} errors exported to ${filename}` 
      });
    } catch (error) {
      toast({ 
        title: "Export Failed", 
        description: "Error creating error report", 
        variant: "destructive" 
      });
    }
  };

  // Phase 3: CRA Wiz Post-Processing Handlers
  const handleCRAWizFileUpload = async (file: File) => {
    setCraWizFile(file);
    setPhase3Result(null);
    
    try {
      const data = await parseCRAWizFile(file);
      setCraWizData(data);
      toast({ 
        title: "CRA Wiz File Loaded", 
        description: `Parsed ${data.length} rows with ${Object.keys(data[0] || {}).length} columns` 
      });
    } catch (error) {
      toast({ 
        title: "Error", 
        description: "Failed to parse CRA Wiz export file", 
        variant: "destructive" 
      });
    }
  };

  const runPhase3Transform = async () => {
    if (craWizData.length === 0) {
      toast({ title: "No Data", description: "Please upload a CRA Wiz export file first", variant: "destructive" });
      return;
    }

    setIsPhase3Processing(true);
    
    try {
      await new Promise(r => setTimeout(r, 500)); // Brief delay for UI feedback
      
      const result = transformCRAWizExport(craWizData);
      setPhase3Result(result);
      
      toast({ 
        title: "Transformation Complete", 
        description: `Converted ${result.inputColumns} columns to ${result.outputColumns} columns. ${result.branchMatchCount} branch matches.` 
      });
    } catch (error) {
      toast({ 
        title: "Transform Failed", 
        description: "Error during CRA Wiz transformation", 
        variant: "destructive" 
      });
    } finally {
      setIsPhase3Processing(false);
    }
  };

  const downloadPhase3WorkItem = () => {
    if (!phase3Result || phase3Result.data.length === 0) {
      toast({ title: "No Data", description: "Run transformation first", variant: "destructive" });
      return;
    }
    
    exportWorkItemFile(phase3Result.data);
    toast({ title: "Download Started", description: "Work Item file is downloading" });
  };

  const downloadPhase3Summary = () => {
    if (!phase3Result) {
      toast({ title: "No Data", description: "Run transformation first", variant: "destructive" });
      return;
    }
    
    exportTransformSummary(phase3Result);
    toast({ title: "Download Started", description: "Summary file is downloading" });
  };

  const downloadCorrectedData = async () => {
    if (processedData.length === 0) {
      toast({ title: "No Data", description: "Run automation first to generate data", variant: "destructive" });
      return;
    }

    try {
      // Import auto-correction function
      const { autoCorrectData } = await import('@/lib/etl-engine');
      
      // Apply auto-corrections
      const correctedData = autoCorrectData(processedData);
      
      const monthYear = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      const filename = `HMDA_Auto_Corrected_${monthYear.replace(' ', '_')}.xlsx`;
      
      // Generate Excel with corrected data
      const ws = utils.json_to_sheet(correctedData);
      const wb = utils.book_new();
      utils.book_append_sheet(wb, ws, "Corrected Data");
      
      // Add a summary sheet
      const summaryData = [{
        'Total Records': correctedData.length,
        'Original Errors': validationErrors.length,
        'Auto-Corrections Applied': 'Census Tract formatting, Rate decimals, State codes, Whitespace trimming',
        'Note': 'Review flagged records - some errors require manual correction'
      }];
      const summaryWs = utils.json_to_sheet(summaryData);
      utils.book_append_sheet(wb, summaryWs, "Correction Summary");
      
      writeFile(wb, filename);
      
      toast({ 
        title: "Corrected Data Downloaded", 
        description: `${correctedData.length} records with auto-fixes applied. Review flagged items.`,
        duration: 5000
      });
    } catch (error) {
      toast({ 
        title: "Export Failed", 
        description: "Error creating corrected file", 
        variant: "destructive" 
      });
    }
  };

  if (!isAuthenticated) {
    return <PasswordGate onUnlock={() => setIsAuthenticated(true)} />;
  }

  return (
    <div className="min-h-screen bg-slate-50 flex">
      {/* Sidebar */}
      <div className="w-64 bg-[#003366] text-white flex flex-col shrink-0">
        <div className="p-6 border-b border-white/10">
          <h1 className="font-bold text-xl tracking-tight">Colony Bank</h1>
          <p className="text-xs text-blue-200 mt-1">HMDA/CRA Automation</p>
        </div>
        
        <nav className="flex-1 p-4 space-y-2">
          <button 
            onClick={() => setActiveTab('upload')}
            className={cn("w-full flex items-center gap-3 px-4 py-3 rounded-md transition-colors", activeTab === 'upload' ? "bg-white/10 text-white" : "text-blue-200 hover:bg-white/5")}
          >
            <Database className="w-4 h-4" />
            <span className="font-medium text-sm">Data Sources</span>
          </button>
          
          <button 
            onClick={() => setActiveTab('process')}
            className={cn("w-full flex items-center gap-3 px-4 py-3 rounded-md transition-colors", activeTab === 'process' ? "bg-white/10 text-white" : "text-blue-200 hover:bg-white/5")}
          >
            <Play className="w-4 h-4" />
            <span className="font-medium text-sm">Run ETL</span>
          </button>
          
          <button 
            onClick={() => setActiveTab('review')}
            className={cn("w-full flex items-center gap-3 px-4 py-3 rounded-md transition-colors", activeTab === 'review' ? "bg-white/10 text-white" : "text-blue-200 hover:bg-white/5")}
          >
            <CheckCircle2 className="w-4 h-4" />
            <span className="font-medium text-sm">Review & Scrub</span>
            {validationErrors.length > 0 && (
              <span className="ml-auto bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">{validationErrors.length}</span>
            )}
          </button>

          <button 
            onClick={() => setActiveTab('phase3')}
            className={cn("w-full flex items-center gap-3 px-4 py-3 rounded-md transition-colors", activeTab === 'phase3' ? "bg-white/10 text-white" : "text-blue-200 hover:bg-white/5")}
          >
            <ArrowRight className="w-4 h-4" />
            <span className="font-medium text-sm">CRA Wiz Post</span>
            <span className="ml-auto bg-orange-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">Step 6</span>
          </button>

          <button 
            onClick={() => setActiveTab('docs')}
            className={cn("w-full flex items-center gap-3 px-4 py-3 rounded-md transition-colors", activeTab === 'docs' ? "bg-white/10 text-white" : "text-blue-200 hover:bg-white/5")}
          >
            <FileScan className="w-4 h-4" />
            <span className="font-medium text-sm">Doc Intelligence</span>
            <span className="ml-auto bg-blue-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">New</span>
          </button>

          <div className="pt-4 mt-4 border-t border-white/10">
            <p className="px-4 text-xs text-blue-400 uppercase font-semibold mb-2">Testing & Tools</p>
            <button 
              onClick={() => setActiveTab('testing')}
              className={cn("w-full flex items-center gap-3 px-4 py-3 rounded-md transition-colors", activeTab === 'testing' ? "bg-white/10 text-white" : "text-blue-200 hover:bg-white/5")}
            >
              <FileDiff className="w-4 h-4" />
              <span className="font-medium text-sm">Diff Testing</span>
            </button>
            
            <button 
              onClick={() => setActiveTab('tutorial')}
              className={cn("w-full flex items-center gap-3 px-4 py-3 rounded-md transition-colors", activeTab === 'tutorial' ? "bg-white/10 text-white" : "text-blue-200 hover:bg-white/5")}
            >
              <Video className="w-4 h-4" />
              <span className="font-medium text-sm">Learning Center</span>
            </button>
          </div>
        </nav>
        
        <div className="p-6 border-t border-white/10">
          <div className="text-xs text-blue-300 mb-2">System Status</div>
          <div className="flex items-center gap-2 text-sm text-green-400">
            <ShieldCheck className="w-4 h-4" />
            Authenticated
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="flex-1 flex flex-col overflow-hidden">
        <header className="bg-white border-b h-16 flex items-center px-8 justify-between">
          <h2 className="text-lg font-semibold text-slate-800">
            {activeTab === 'upload' && 'Phase 1: Data Extraction'}
            {activeTab === 'process' && 'Phase 2-3: Transformation & Validation'}
            {activeTab === 'review' && 'Phase 4: Scrub Preparation'}
            {activeTab === 'phase3' && 'Phase 3: CRA Wiz Post-Processing'}
            {activeTab === 'docs' && 'Phase 5: Document Intelligence'}
            {activeTab === 'tutorial' && 'Learning Center'}
          </h2>
          <div className="flex items-center gap-4">
            <div className="text-sm text-slate-500">
              Period: <span className="font-medium text-slate-900">{new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
            </div>
          </div>
        </header>

        <main className="flex-1 overflow-auto p-8">
          
          <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full max-w-5xl mx-auto">
            
            {/* UPLOAD TAB */}
            <TabsContent value="upload" className="space-y-6 mt-0">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <Card>
                  <CardHeader>
                    <CardTitle className="text-base">Input A: LaserPro</CardTitle>
                    <CardDescription>Commercial HUDDA Loans (Text)</CardDescription>
                  </CardHeader>
                  <CardContent>
                    <FileUpload 
                      label="LaserPro Export" 
                      onFileSelect={(f) => handleFileUpload('laserPro', f)} 
                      file={files.laserPro}
                    />
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                     <CardTitle className="text-base">Input B: Encompass</CardTitle>
                     <CardDescription>Consumer Loans Primary (Excel)</CardDescription>
                  </CardHeader>
                  <CardContent>
                    <FileUpload 
                      label="Encompass HUDDA" 
                      onFileSelect={(f) => handleFileUpload('encompass', f)}
                      file={files.encompass}
                    />
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                     <CardTitle className="text-base">Input C: Supplemental</CardTitle>
                     <CardDescription>Encompass Additional Data (Excel)</CardDescription>
                  </CardHeader>
                  <CardContent>
                    <FileUpload 
                      label="Supplemental Export" 
                      onFileSelect={(f) => handleFileUpload('supp', f)}
                      file={files.supp}
                    />
                  </CardContent>
                </Card>
              </div>

              <div className="flex justify-end gap-3">
                <Button 
                  onClick={() => setActiveTab('process')} 
                  className="bg-[#003366] hover:bg-[#002244]"
                >
                  Continue to Phase 2 <ArrowRight className="ml-2 w-4 h-4" />
                </Button>
              </div>
            </TabsContent>

            {/* PROCESS TAB */}
            <TabsContent value="process" className="space-y-6 mt-0">
              <div className="grid grid-cols-3 gap-6">
                <Card className="col-span-2">
                  <CardHeader>
                    <CardTitle>Transformation Pipeline</CardTitle>
                    <CardDescription>Execution of Phase 2 & 3 Logic</CardDescription>
                  </CardHeader>
                  <CardContent>
                    <div className="bg-slate-950 text-slate-50 font-mono text-sm p-4 rounded-md h-[300px] overflow-y-auto shadow-inner">
                      {logs.length === 0 && <span className="text-slate-500">Ready to start...</span>}
                      {logs.map((log, i) => (
                        <div key={i} className="mb-1 border-b border-slate-800/50 pb-1 last:border-0">{log}</div>
                      ))}
                      {isProcessing && (
                        <div className="flex items-center gap-2 text-blue-400 mt-2">
                          <Loader2 className="w-3 h-3 animate-spin" /> Processing...
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                    <CardTitle>Actions</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <Button 
                      className="w-full bg-[#003366] hover:bg-[#002244]" 
                      size="lg"
                      onClick={runEtlProcess}
                      disabled={isProcessing}
                    >
                      {isProcessing ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Play className="mr-2 h-4 w-4" />}
                      Run Automation
                    </Button>
                    <div className="text-xs text-muted-foreground px-2">
                      <p className="font-medium mb-1">Pipeline Steps:</p>
                      <ul className="list-disc pl-3 space-y-1">
                        <li>Column Calculation (Term, Branch)</li>
                        <li>VLOOKUP Merge (Supp Data)</li>
                        <li>Format Cleaning (APR, Tract)</li>
                        <li>CRA Wiz Validation Simulation</li>
                      </ul>
                    </div>
                  </CardContent>
                </Card>
              </div>
            </TabsContent>

            {/* REVIEW TAB */}
            <TabsContent value="review" className="space-y-6 mt-0">
              {stats && (
                <div className="grid grid-cols-4 gap-4">
                  <Card className="bg-white">
                    <CardContent className="pt-6">
                      <div className="text-2xl font-bold text-[#003366]">{stats.totalRecords}</div>
                      <div className="text-xs text-muted-foreground font-medium uppercase tracking-wide">Total Records</div>
                    </CardContent>
                  </Card>
                  <Card className="bg-white">
                    <CardContent className="pt-6">
                      <div className="text-2xl font-bold text-green-600">
                        {new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: 'compact' }).format(stats.totalLoanAmount)}
                      </div>
                      <div className="text-xs text-muted-foreground font-medium uppercase tracking-wide">Total Volume</div>
                    </CardContent>
                  </Card>
                  <Card className={cn("transition-colors", validationErrors.length > 0 ? "bg-red-50 border-red-200" : "bg-white")}>
                    <CardContent className="pt-6">
                      <div className={cn("text-2xl font-bold", validationErrors.length > 0 ? "text-red-600" : "text-slate-900")}>
                        {validationErrors.length}
                      </div>
                      <div className="text-xs text-muted-foreground font-medium uppercase tracking-wide">Validation Errors</div>
                    </CardContent>
                  </Card>
                  <Card className="bg-white">
                    <CardContent className="pt-6 flex flex-col gap-2">
                      <Button 
                        size="sm" 
                        className="w-full bg-green-600 hover:bg-green-700 text-white" 
                        onClick={downloadCorrectedData}
                      >
                        <CheckCircle2 className="mr-2 h-3 w-3" /> Download Corrected
                      </Button>
                      <Button variant="outline" size="sm" className="w-full" onClick={downloadMailMerge}>
                        <Download className="mr-2 h-3 w-3" /> Export Mail Merge
                      </Button>
                      <Button variant="outline" size="sm" className="w-full" onClick={downloadCRAWiz}>
                        <Database className="mr-2 h-3 w-3" /> Export CRA Wiz
                      </Button>
                      {validationErrors.length > 0 && (
                        <Button variant="outline" size="sm" className="w-full text-red-600 border-red-200 hover:bg-red-50" onClick={downloadValidationReport}>
                          <AlertTriangle className="mr-2 h-3 w-3" /> Error Report
                        </Button>
                      )}
                    </CardContent>
                  </Card>
                </div>
              )}

              <Card>
                <CardHeader>
                  <CardTitle>Data Review</CardTitle>
                  <CardDescription>Review processed records. Validated against CRA Wiz rules.</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="rounded-md border overflow-hidden">
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm text-left">
                        <thead className="bg-slate-100 text-slate-600 font-medium border-b">
                          <tr>
                            <th className="px-4 py-3">Appl Numb</th>
                            <th className="px-4 py-3">Branch</th>
                            <th className="px-4 py-3">Term (Yrs)</th>
                            <th className="px-4 py-3">APR</th>
                            <th className="px-4 py-3">Status</th>
                            <th className="px-4 py-3">Issues</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y">
                          {processedData.map((row, i) => {
                            const loanId = row.Loan_Number || row.ApplNumb || '-';
                            const error = validationErrors.find(e => e.applNumb === loanId);
                            const termYears = row['Loan Term Years'] || (row.Loan_Term_Months ? row.Loan_Term_Months / 12 : '-');
                            const apr = row['APR'] || row.Interest_Rate || '-';
                            const branch = row['Branch Name'] || row['Branch'] || row.Property_City || '-';
                            
                            return (
                              <tr key={i} className={cn("hover:bg-slate-50 transition-colors", error ? "bg-red-50/50 hover:bg-red-50" : "")}>
                                <td className="px-4 py-3 font-medium">{loanId}</td>
                                <td className="px-4 py-3">{branch}</td>
                                <td className="px-4 py-3">{termYears}</td>
                                <td className="px-4 py-3">{apr}{typeof apr === 'number' ? '%' : ''}</td>
                                <td className="px-4 py-3">
                                  {error ? (
                                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700">
                                      <AlertTriangle className="w-3 h-3 mr-1" /> Review
                                    </span>
                                  ) : (
                                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700">
                                      <CheckCircle2 className="w-3 h-3 mr-1" /> Valid
                                    </span>
                                  )}
                                </td>
                                <td className="px-4 py-3 text-red-600 text-xs">
                                  {error?.errors.join(", ")}
                                </td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            {/* PHASE 3: CRA WIZ POST-PROCESSING TAB */}
            <TabsContent value="phase3" className="space-y-6 mt-0">
              <div className="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-lg p-4 mb-4">
                <div className="flex items-start gap-3">
                  <div className="bg-orange-100 p-2 rounded-lg">
                    <ArrowRight className="w-5 h-5 text-orange-600" />
                  </div>
                  <div>
                    <h3 className="font-semibold text-orange-900">Step 6: CRA Wiz Return Processing</h3>
                    <p className="text-sm text-orange-700 mt-1">
                      Upload the file you downloaded from CRA Wiz after processing. This converts the 243-column CRA Wiz export to the 125-column work item format with Branch VLOOKUP applied.
                    </p>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-6">
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <FileText className="w-5 h-5 text-orange-600" />
                      Upload CRA Wiz Export
                    </CardTitle>
                    <CardDescription>
                      Upload the CSV file downloaded from CRA Wiz after processing
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <FileUpload 
                      label="CRA Wiz Export File (CSV)"
                      description="243-column CRA Wiz HMDA export"
                      onFileSelect={(file) => handleCRAWizFileUpload(file)}
                      file={craWizFile}
                      accept={{'text/csv': ['.csv'], 'application/vnd.ms-excel': ['.xls', '.xlsx']}}
                    />
                    
                    {craWizData.length > 0 && (
                      <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div className="flex items-center gap-2 text-green-700">
                          <CheckCircle2 className="w-4 h-4" />
                          <span className="font-medium">File Loaded Successfully</span>
                        </div>
                        <div className="mt-2 text-sm text-green-600">
                          {craWizData.length} rows  {Object.keys(craWizData[0] || {}).length} columns
                        </div>
                      </div>
                    )}
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                      <Database className="w-5 h-5 text-blue-600" />
                      Branch List Reference
                    </CardTitle>
                    <CardDescription>
                      Using built-in Colony Bank branch list (48 branches)
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <div className="flex items-center gap-2 text-blue-700 mb-2">
                        <CheckCircle2 className="w-4 h-4" />
                        <span className="font-medium">Branch List Ready</span>
                      </div>
                      <p className="text-sm text-blue-600 mb-3">
                        {Object.keys(BRANCH_LIST).length} branches configured for VLOOKUP
                      </p>
                      <div className="max-h-32 overflow-y-auto text-xs font-mono bg-white rounded p-2 border">
                        {Object.entries(BRANCH_LIST).slice(0, 10).map(([num, name]) => (
                          <div key={num} className="py-0.5">{num}: {name}</div>
                        ))}
                        <div className="text-slate-400 italic">...and {Object.keys(BRANCH_LIST).length - 10} more</div>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </div>

              <Card>
                <CardHeader>
                  <CardTitle>Transform Actions</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <Button 
                    className="w-full bg-orange-600 hover:bg-orange-700" 
                    size="lg"
                    onClick={runPhase3Transform}
                    disabled={isPhase3Processing || craWizData.length === 0}
                  >
                    {isPhase3Processing ? (
                      <>
                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                        Transforming...
                      </>
                    ) : (
                      <>
                        <Play className="mr-2 h-4 w-4" />
                        Transform for Work Items
                      </>
                    )}
                  </Button>

                  <div className="text-xs text-muted-foreground px-2">
                    <p className="font-medium mb-1">Transformation Steps:</p>
                    <ul className="list-disc pl-3 space-y-1">
                      <li>Apply Branch VLOOKUP (BRANCHNUMB  BRANCHNAME)</li>
                      <li>Add new columns: ErrorMadeBy, DSC (blank)</li>
                      <li>Remove 118 unwanted columns</li>
                      <li>Reorder to exact 125-column format</li>
                    </ul>
                  </div>
                </CardContent>
              </Card>

              {phase3Result && (
                <>
                  <div className="grid grid-cols-4 gap-4">
                    <Card className="bg-white">
                      <CardContent className="pt-6">
                        <div className="text-2xl font-bold text-orange-600">{phase3Result.inputColumns}</div>
                        <div className="text-xs text-muted-foreground font-medium uppercase tracking-wide">Input Columns</div>
                      </CardContent>
                    </Card>
                    <Card className="bg-white">
                      <CardContent className="pt-6">
                        <div className="text-2xl font-bold text-green-600">{phase3Result.outputColumns}</div>
                        <div className="text-xs text-muted-foreground font-medium uppercase tracking-wide">Output Columns</div>
                      </CardContent>
                    </Card>
                    <Card className="bg-white">
                      <CardContent className="pt-6">
                        <div className="text-2xl font-bold text-blue-600">{phase3Result.rowCount}</div>
                        <div className="text-xs text-muted-foreground font-medium uppercase tracking-wide">Total Rows</div>
                      </CardContent>
                    </Card>
                    <Card className={cn("bg-white", phase3Result.branchMissCount > 0 && "border-yellow-300 bg-yellow-50")}>
                      <CardContent className="pt-6">
                        <div className={cn("text-2xl font-bold", phase3Result.branchMissCount > 0 ? "text-yellow-600" : "text-green-600")}>
                          {phase3Result.branchMatchCount}/{phase3Result.rowCount}
                        </div>
                        <div className="text-xs text-muted-foreground font-medium uppercase tracking-wide">Branch Matches</div>
                      </CardContent>
                    </Card>
                  </div>

                  <Card>
                    <CardHeader>
                      <CardTitle>Data Preview</CardTitle>
                      <CardDescription>First 5 rows of transformed data (125 columns)</CardDescription>
                    </CardHeader>
                    <CardContent>
                      <div className="rounded-md border overflow-hidden">
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm text-left">
                            <thead className="bg-slate-100 text-slate-600 font-medium border-b">
                              <tr>
                                <th className="px-4 py-3">BRANCHNAME</th>
                                <th className="px-4 py-3">BRANCHNUMB</th>
                                <th className="px-4 py-3">LEI</th>
                                <th className="px-4 py-3">ULI</th>
                                <th className="px-4 py-3">LASTNAME</th>
                                <th className="px-4 py-3">FIRSTNAME</th>
                                <th className="px-4 py-3">LENDER</th>
                                <th className="px-4 py-3">LOANAMOUNTINDOLLARS</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y">
                              {phase3Result.data.slice(0, 5).map((row, i) => (
                                <tr key={i} className="hover:bg-slate-50">
                                  <td className="px-4 py-3 font-medium">{row.BRANCHNAME || '-'}</td>
                                  <td className="px-4 py-3">{row.BRANCHNUMB || '-'}</td>
                                  <td className="px-4 py-3 truncate max-w-[100px]">{row.LEI || '-'}</td>
                                  <td className="px-4 py-3 truncate max-w-[100px]">{row.ULI || '-'}</td>
                                  <td className="px-4 py-3">{row.LASTNAME || '-'}</td>
                                  <td className="px-4 py-3">{row.FIRSTNAME || '-'}</td>
                                  <td className="px-4 py-3">{row.LENDER || '-'}</td>
                                  <td className="px-4 py-3">${Number(row.LOANAMOUNTINDOLLARS || 0).toLocaleString()}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  <div className="flex gap-4">
                    <Button 
                      className="flex-1 bg-green-600 hover:bg-green-700" 
                      size="lg"
                      onClick={downloadPhase3WorkItem}
                    >
                      <Download className="mr-2 h-4 w-4" />
                      Download Work Item File
                    </Button>
                    <Button 
                      variant="outline" 
                      size="lg"
                      onClick={downloadPhase3Summary}
                    >
                      <FileText className="mr-2 h-4 w-4" />
                      Download Summary
                    </Button>
                  </div>
                </>
              )}
            </TabsContent>

            {/* DOCUMENT INTELLIGENCE TAB (MOCK) */}
            <TabsContent value="docs" className="space-y-6 mt-0">
              <Card>
                <CardHeader>
                  <CardTitle>Document-Based Data Extraction (Phase 5)</CardTitle>
                  <CardDescription>Automated extraction from PDF loan documents (Closing Disclosures, Notes, Appraisals).</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    <div className="text-center mb-4">
                      <FileScan className="w-12 h-12 text-blue-300 mb-4 mx-auto" />
                      <h3 className="text-lg font-medium text-slate-900">Upload Loan Document Packages</h3>
                      <p className="text-sm text-slate-500 mt-2 max-w-md mx-auto">
                        Upload multiple PDF or text files to automatically extract interest rates, loan terms, and property details.
                      </p>
                    </div>
                    
                    <MultiFileUpload 
                      label="Document Files (PDF/Text)" 
                      description="Drag & drop multiple files or click to select"
                      onFilesSelect={handleDocumentFilesUpload}
                      files={documentFiles}
                      onRemoveFile={handleRemoveDocumentFile}
                      accept={{'application/pdf': ['.pdf'], 'text/plain': ['.txt']}}
                    />

                    {documentFiles.length > 0 && (
                      <div className="flex justify-end gap-2 pt-4">
                        <Button 
                          variant="outline" 
                          onClick={() => setDocumentFiles([])}
                          data-testid="button-clear-all"
                        >
                          Clear All
                        </Button>
                        <Button 
                          className="bg-[#003366] hover:bg-[#002244]"
                          data-testid="button-process-documents"
                        >
                          Process {documentFiles.length} Document{documentFiles.length !== 1 ? 's' : ''}
                        </Button>
                      </div>
                    )}
                  </div>

                  <div className="mt-8">
                    <h4 className="text-sm font-medium text-slate-700 mb-4">Extraction Capabilities Preview</h4>
                    <div className="grid grid-cols-3 gap-4">
                      <div className="p-4 bg-white border rounded-md shadow-sm">
                        <div className="text-xs text-slate-400 uppercase font-bold mb-2">Closing Disclosure</div>
                        <ul className="space-y-2 text-sm">
                          <li className="flex items-center gap-2 text-green-600"><CheckCircle2 className="w-3 h-3" /> Loan Term</li>
                          <li className="flex items-center gap-2 text-green-600"><CheckCircle2 className="w-3 h-3" /> Interest Rate</li>
                          <li className="flex items-center gap-2 text-green-600"><CheckCircle2 className="w-3 h-3" /> Loan Purpose</li>
                        </ul>
                      </div>
                      <div className="p-4 bg-white border rounded-md shadow-sm">
                        <div className="text-xs text-slate-400 uppercase font-bold mb-2">Credit Report</div>
                         <ul className="space-y-2 text-sm">
                          <li className="flex items-center gap-2 text-green-600"><CheckCircle2 className="w-3 h-3" /> Middle Score Logic</li>
                          <li className="flex items-center gap-2 text-green-600"><CheckCircle2 className="w-3 h-3" /> Applicant Age</li>
                          <li className="flex items-center gap-2 text-green-600"><CheckCircle2 className="w-3 h-3" /> Bureau Source</li>
                        </ul>
                      </div>
                      <div className="p-4 bg-white border rounded-md shadow-sm">
                        <div className="text-xs text-slate-400 uppercase font-bold mb-2">Appraisal</div>
                         <ul className="space-y-2 text-sm">
                          <li className="flex items-center gap-2 text-green-600"><CheckCircle2 className="w-3 h-3" /> Construction Method</li>
                          <li className="flex items-center gap-2 text-green-600"><CheckCircle2 className="w-3 h-3" /> Property Address</li>
                          <li className="flex items-center gap-2 text-green-600"><CheckCircle2 className="w-3 h-3" /> Occupancy Type</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="tutorial" className="mt-0">
              <TutorialVideo />
            </TabsContent>

          </Tabs>
        </main>
      </div>
    </div>
  );
}

================================================================================
FILE: client/src/components/password-gate.tsx
================================================================================
import { useState } from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Lock, AlertCircle, Loader2 } from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

interface PasswordGateProps {
  onUnlock: () => void;
}

export function PasswordGate({ onUnlock }: PasswordGateProps) {
  const [password, setPassword] = useState('');
  const [error, setError] = useState(false);
  const [isValidating, setIsValidating] = useState(false);
  const { toast } = useToast();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    setIsValidating(true);
    try {
      const response = await fetch('/api/auth/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });
      
      const data = await response.json();
      
      if (data.success) {
        onUnlock();
        toast({ title: "Access Granted", description: "Welcome to Colony Bank ETL Tool" });
      } else {
        setError(true);
        toast({ title: "Access Denied", description: "Incorrect password.", variant: "destructive" });
      }
    } catch (err) {
      setError(true);
      toast({ title: "Authentication Error", description: "Unable to validate credentials.", variant: "destructive" });
    } finally {
      setIsValidating(false);
    }
  };

  return (
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
      <Card className="w-full max-w-md shadow-xl border-slate-200">
        <CardHeader className="text-center space-y-2 pb-2">
          <div className="mx-auto w-12 h-12 bg-[#003366] rounded-full flex items-center justify-center mb-2">
            <Lock className="w-6 h-6 text-white" />
          </div>
          <CardTitle className="text-xl font-bold text-[#003366]">Colony Bank HMDA/CRA</CardTitle>
          <CardDescription>Enter authorized password to access ETL tools</CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Input
                type="password"
                placeholder="Enter Password"
                value={password}
                onChange={(e) => {
                  setPassword(e.target.value);
                  setError(false);
                }}
                className={error ? "border-red-500 focus-visible:ring-red-500" : ""}
                disabled={isValidating}
                data-testid="input-password"
              />
              {error && (
                <div className="flex items-center gap-1.5 text-sm text-red-600">
                  <AlertCircle className="w-4 h-4" />
                  <span>Incorrect password. Please try again.</span>
                </div>
              )}
            </div>
            <Button 
              type="submit" 
              className="w-full bg-[#003366] hover:bg-[#002244]"
              disabled={isValidating}
              data-testid="button-authenticate"
            >
              {isValidating ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Validating...
                </>
              ) : (
                'Authenticate'
              )}
            </Button>
          </form>
          <div className="mt-6 text-center text-xs text-muted-foreground">
            Authorized Personnel Only  {new Date().getFullYear()} Colony Bank
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

================================================================================
FILE: client/src/components/file-upload.tsx
================================================================================
import { useState, useCallback, useRef } from 'react';
import { Upload, FileSpreadsheet, CheckCircle } from 'lucide-react';
import { cn } from '@/lib/utils';

interface FileUploadProps {
  label: string;
  description?: string;
  accept?: Record<string, string[]>;
  onFileSelect: (file: File) => void;
  file?: File | null;
}

export function FileUpload({ label, description, accept, onFileSelect, file }: FileUploadProps) {
  const [isDragActive, setIsDragActive] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);

  const handleDrag = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setIsDragActive(true);
    } else if (e.type === 'dragleave') {
      setIsDragActive(false);
    }
  }, []);

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragActive(false);
    
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      onFileSelect(e.dataTransfer.files[0]);
    }
  }, [onFileSelect]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    e.preventDefault();
    if (e.target.files && e.target.files[0]) {
      onFileSelect(e.target.files[0]);
    }
  };

  const onButtonClick = () => {
    inputRef.current?.click();
  };

  // Simple accept string for input
  const acceptString = accept 
    ? Object.values(accept).flat().join(',')
    : ".xlsx,.xls,.csv,.txt,.pdf";

  return (
    <div className="w-full">
      <div className="flex items-center justify-between mb-2">
        <label className="text-sm font-medium text-foreground">{label}</label>
        {file && (
          <span className="text-xs text-green-600 flex items-center gap-1">
            <CheckCircle className="w-3 h-3" /> Uploaded
          </span>
        )}
      </div>
      
      <div
        onDragEnter={handleDrag}
        onDragLeave={handleDrag}
        onDragOver={handleDrag}
        onDrop={handleDrop}
        onClick={onButtonClick}
        className={cn(
          "border-2 border-dashed rounded-lg p-6 transition-colors cursor-pointer flex flex-col items-center justify-center text-center min-h-[120px]",
          isDragActive ? "border-primary bg-primary/5" : "border-border bg-card hover:bg-accent/50",
          file ? "border-green-200 bg-green-50/30" : ""
        )}
      >
        <input 
          ref={inputRef}
          type="file" 
          className="hidden" 
          onChange={handleChange}
          accept={acceptString}
        />
        
        {file ? (
          <div className="flex flex-col items-center gap-2">
            <div className="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600">
              <FileSpreadsheet className="w-5 h-5" />
            </div>
            <p className="text-sm font-medium text-foreground">{file.name}</p>
            <p className="text-xs text-muted-foreground">{(file.size / 1024).toFixed(1)} KB</p>
          </div>
        ) : (
          <div className="flex flex-col items-center gap-2">
            <div className="w-10 h-10 rounded-full bg-secondary flex items-center justify-center text-muted-foreground">
              <Upload className="w-5 h-5" />
            </div>
            <p className="text-sm text-muted-foreground">
              {isDragActive ? "Drop file here..." : description || "Drag & drop or click to upload"}
            </p>
          </div>
        )}
      </div>
    </div>
  );
}

================================================================================
FILE: client/src/components/multi-file-upload.tsx
================================================================================
import { useState, useCallback, useRef } from 'react';
import { Upload, FileText, X, CheckCircle } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';

interface MultiFileUploadProps {
  label: string;
  description?: string;
  accept?: Record<string, string[]>;
  onFilesSelect: (files: File[]) => void;
  files: File[];
  onRemoveFile: (index: number) => void;
}

export function MultiFileUpload({ 
  label, 
  description, 
  accept, 
  onFilesSelect, 
  files,
  onRemoveFile 
}: MultiFileUploadProps) {
  const [isDragActive, setIsDragActive] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);

  const handleDrag = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setIsDragActive(true);
    } else if (e.type === 'dragleave') {
      setIsDragActive(false);
    }
  }, []);

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragActive(false);
    
    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      const newFiles = Array.from(e.dataTransfer.files);
      onFilesSelect(newFiles);
    }
  }, [onFilesSelect]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    e.preventDefault();
    if (e.target.files && e.target.files.length > 0) {
      const newFiles = Array.from(e.target.files);
      onFilesSelect(newFiles);
    }
  };

  const onButtonClick = () => {
    inputRef.current?.click();
  };

  const acceptString = accept 
    ? Object.values(accept).flat().join(',')
    : ".xlsx,.xls,.csv,.txt,.pdf";

  return (
    <div className="w-full">
      <div className="flex items-center justify-between mb-2">
        <label className="text-sm font-medium text-foreground">{label}</label>
        {files.length > 0 && (
          <span className="text-xs text-green-600 flex items-center gap-1">
            <CheckCircle className="w-3 h-3" /> {files.length} file{files.length !== 1 ? 's' : ''}
          </span>
        )}
      </div>
      
      <div
        onDragEnter={handleDrag}
        onDragLeave={handleDrag}
        onDragOver={handleDrag}
        onDrop={handleDrop}
        onClick={onButtonClick}
        className={cn(
          "border-2 border-dashed rounded-lg p-6 transition-colors cursor-pointer flex flex-col items-center justify-center text-center min-h-[120px]",
          isDragActive ? "border-primary bg-primary/5" : "border-border bg-card hover:bg-accent/50",
          files.length > 0 ? "border-green-200 bg-green-50/30" : ""
        )}
      >
        <input 
          ref={inputRef}
          type="file" 
          className="hidden" 
          onChange={handleChange}
          accept={acceptString}
          multiple
        />
        
        <div className="flex flex-col items-center gap-2">
          <div className="w-10 h-10 rounded-full bg-secondary flex items-center justify-center text-muted-foreground">
            <Upload className="w-5 h-5" />
          </div>
          <p className="text-sm text-muted-foreground">
            {isDragActive ? "Drop files here..." : description || "Drag & drop multiple files or click to upload"}
          </p>
        </div>
      </div>

      {files.length > 0 && (
        <div className="mt-4 space-y-2">
          {files.map((file, index) => (
            <div 
              key={index} 
              className="flex items-center justify-between bg-white border rounded-lg px-3 py-2 hover:bg-slate-50 transition-colors"
              data-testid={`file-item-${index}`}
            >
              <div className="flex items-center gap-3 flex-1 min-w-0">
                <div className="w-8 h-8 rounded bg-green-100 flex items-center justify-center text-green-600 shrink-0">
                  <FileText className="w-4 h-4" />
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-foreground truncate">{file.name}</p>
                  <p className="text-xs text-muted-foreground">{(file.size / 1024).toFixed(1)} KB</p>
                </div>
              </div>
              <Button
                variant="ghost"
                size="sm"
                onClick={(e) => {
                  e.stopPropagation();
                  onRemoveFile(index);
                }}
                className="shrink-0"
                data-testid={`button-remove-${index}`}
              >
                <X className="w-4 h-4" />
              </Button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

================================================================================
FILE: client/src/App.tsx
================================================================================
import { Switch, Route } from "wouter";
import { queryClient } from "./lib/queryClient";
import { QueryClientProvider } from "@tanstack/react-query";
import { Toaster } from "@/components/ui/toaster";
import { TooltipProvider } from "@/components/ui/tooltip";
import NotFound from "@/pages/not-found";
import Dashboard from "@/pages/dashboard";

function Router() {
  return (
    <Switch>
      <Route path="/" component={Dashboard} />
      <Route component={NotFound} />
    </Switch>
  );
}

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <TooltipProvider>
        <Toaster />
        <Router />
      </TooltipProvider>
    </QueryClientProvider>
  );
}

export default App;

================================================================================
FILE: server/index.ts
================================================================================
import express, { type Request, Response, NextFunction } from "express";
import { registerRoutes } from "./routes";
import { setupVite, serveStatic, log } from "./vite";

const app = express();

declare module 'http' {
  interface IncomingMessage {
    rawBody: unknown
  }
}
app.use(express.json({
  verify: (req, _res, buf) => {
    req.rawBody = buf;
  }
}));
app.use(express.urlencoded({ extended: false }));

app.use((req, res, next) => {
  const start = Date.now();
  const path = req.path;
  let capturedJsonResponse: Record<string, any> | undefined = undefined;

  const originalResJson = res.json;
  res.json = function (bodyJson, ...args) {
    capturedJsonResponse = bodyJson;
    return originalResJson.apply(res, [bodyJson, ...args]);
  };

  res.on("finish", () => {
    const duration = Date.now() - start;
    if (path.startsWith("/api")) {
      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;
      if (capturedJsonResponse) {
        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;
      }

      if (logLine.length > 80) {
        logLine = logLine.slice(0, 79) + "";
      }

      log(logLine);
    }
  });

  next();
});

(async () => {
  const server = await registerRoutes(app);

  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {
    const status = err.status || err.statusCode || 500;
    const message = err.message || "Internal Server Error";

    res.status(status).json({ message });
    throw err;
  });

  // importantly only setup vite in development and after
  // setting up all the other routes so the catch-all route
  // doesn't interfere with the other routes
  if (app.get("env") === "development") {
    await setupVite(app, server);
  } else {
    serveStatic(app);
  }

  // ALWAYS serve the app on the port specified in the environment variable PORT
  // Other ports are firewalled. Default to 5000 if not specified.
  // this serves both the API and the client.
  // It is the only port that is not firewalled.
  const port = parseInt(process.env.PORT || '5000', 10);
  server.listen({
    port,
    host: "0.0.0.0",
    reusePort: true,
  }, () => {
    log(`serving on port ${port}`);
  });
})();

================================================================================
FILE: server/routes.ts
================================================================================
import type { Express } from "express";
import { createServer, type Server } from "http";
import { storage } from "./storage";
import { insertAuditLogSchema } from "@shared/schema";

const VALID_PASSWORD = "ColonyBank2024!";

export async function registerRoutes(app: Express): Promise<Server> {
  app.post("/api/auth/validate", async (req, res) => {
    const { password } = req.body;
    
    if (password === VALID_PASSWORD) {
      res.json({ success: true });
    } else {
      res.status(401).json({ success: false, message: "Invalid password" });
    }
  });

  app.post("/api/audit/log", async (req, res) => {
    try {
      const validatedData = insertAuditLogSchema.parse(req.body);
      const auditLog = await storage.createAuditLog(validatedData);
      res.json(auditLog);
    } catch (error) {
      res.status(400).json({ error: "Invalid audit log data" });
    }
  });

  app.get("/api/audit/logs", async (req, res) => {
    const limit = req.query.limit ? parseInt(req.query.limit as string) : 100;
    const logs = await storage.getAuditLogs(limit);
    res.json(logs);
  });

  app.get("/api/audit/logs/:username", async (req, res) => {
    const logs = await storage.getAuditLogsByUsername(req.params.username);
    res.json(logs);
  });

  const httpServer = createServer(app);

  return httpServer;
}

================================================================================
FILE: server/storage.ts
================================================================================
import { type AuditLog, type InsertAuditLog } from "@shared/schema";
import { randomUUID } from "crypto";

export interface IStorage {
  createAuditLog(log: InsertAuditLog): Promise<AuditLog>;
  getAuditLogs(limit?: number): Promise<AuditLog[]>;
  getAuditLogsByUsername(username: string): Promise<AuditLog[]>;
}

export class MemStorage implements IStorage {
  private auditLogs: Map<string, AuditLog>;

  constructor() {
    this.auditLogs = new Map();
  }

  async createAuditLog(insertLog: InsertAuditLog): Promise<AuditLog> {
    const id = randomUUID();
    const log: AuditLog = { 
      ...insertLog, 
      id,
      timestamp: new Date()
    };
    this.auditLogs.set(id, log);
    return log;
  }

  async getAuditLogs(limit: number = 100): Promise<AuditLog[]> {
    return Array.from(this.auditLogs.values())
      .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime())
      .slice(0, limit);
  }

  async getAuditLogsByUsername(username: string): Promise<AuditLog[]> {
    return Array.from(this.auditLogs.values())
      .filter(log => log.username === username)
      .sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
  }
}

export const storage = new MemStorage();

================================================================================
FILE: shared/schema.ts
================================================================================
import { sql } from "drizzle-orm";
import { pgTable, text, varchar, timestamp, integer } from "drizzle-orm/pg-core";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

export const processingAuditLog = pgTable("processing_audit_log", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  timestamp: timestamp("timestamp").notNull().defaultNow(),
  username: text("username").notNull(),
  filesProcessed: integer("files_processed").notNull(),
  recordsProcessed: integer("records_processed").notNull(),
  validationErrors: integer("validation_errors").notNull(),
  phase: text("phase").notNull(),
});

export const insertAuditLogSchema = createInsertSchema(processingAuditLog).omit({
  id: true,
  timestamp: true,
});

export type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;
export type AuditLog = typeof processingAuditLog.$inferSelect;

================================================================================
FILE: package.json
================================================================================
{
  "name": "rest-express",
  "version": "1.0.0",
  "type": "module",
  "license": "MIT",
  "scripts": {
    "dev:client": "vite dev --port 5000",
    "dev": "NODE_ENV=development tsx server/index.ts",
    "build": "vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist",
    "start": "NODE_ENV=production node dist/index.js",
    "check": "tsc",
    "db:push": "drizzle-kit push"
  },
  "notes": "removed framer motion dependency",
  "dependencies": {
    "@hookform/resolvers": "^3.10.0",
    "@jridgewell/trace-mapping": "^0.3.25",
    "@neondatabase/serverless": "^0.10.4",
    "@radix-ui/react-accordion": "^1.2.12",
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-aspect-ratio": "^1.1.8",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-checkbox": "^1.3.3",
    "@radix-ui/react-collapsible": "^1.1.12",
    "@radix-ui/react-context-menu": "^2.2.16",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-hover-card": "^1.1.15",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-menubar": "^1.1.16",
    "@radix-ui/react-navigation-menu": "^1.2.14",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-progress": "^1.1.8",
    "@radix-ui/react-radio-group": "^1.3.8",
    "@radix-ui/react-scroll-area": "^1.2.10",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-slider": "^1.3.6",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "@radix-ui/react-toast": "^1.2.7",
    "@radix-ui/react-toggle": "^1.1.10",
    "@radix-ui/react-toggle-group": "^1.1.11",
    "@radix-ui/react-tooltip": "^1.2.8",
    "@tanstack/react-query": "^5.60.5",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "connect-pg-simple": "^10.0.0",
    "date-fns": "^3.6.0",
    "drizzle-orm": "^0.39.1",
    "drizzle-zod": "^0.7.0",
    "embla-carousel-react": "^8.6.0",
    "express": "^4.21.2",
    "express-session": "^1.18.1",
    "framer-motion": "^12.23.24",
    "input-otp": "^1.4.2",
    "lucide-react": "^0.545.0",
    "memorystore": "^1.6.7",
    "next-themes": "^0.4.6",
    "passport": "^0.7.0",
    "passport-local": "^1.0.0",
    "react": "^19.2.0",
    "react-day-picker": "^9.11.1",
    "react-dom": "^19.2.0",
    "react-hook-form": "^7.66.0",
    "react-resizable-panels": "^2.1.9",
    "recharts": "^2.15.4",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.3.1",
    "tailwindcss-animate": "^1.0.7",
    "tw-animate-css": "^1.4.0",
    "vaul": "^1.1.2",
    "wouter": "^3.3.5",
    "ws": "^8.18.0",
    "xlsx": "^0.18.5",
    "zod": "^3.25.76",
    "zod-validation-error": "^3.4.0"
  },
  "devDependencies": {
    "@replit/vite-plugin-cartographer": "^0.4.4",
    "@replit/vite-plugin-dev-banner": "^0.1.1",
    "@replit/vite-plugin-runtime-error-modal": "^0.0.3",
    "@tailwindcss/vite": "^4.1.14",
    "@types/connect-pg-simple": "^7.0.3",
    "@types/express": "4.17.21",
    "@types/express-session": "^1.18.0",
    "@types/node": "^20.19.0",
    "@types/passport": "^1.0.16",
    "@types/passport-local": "^1.0.38",
    "@types/react": "^19.2.0",
    "@types/react-dom": "^19.2.0",
    "@types/ws": "^8.5.13",
    "@vitejs/plugin-react": "^5.0.4",
    "autoprefixer": "^10.4.21",
    "drizzle-kit": "^0.31.4",
    "esbuild": "^0.25.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.14",
    "tsx": "^4.20.5",
    "typescript": "5.6.3",
    "vite": "^7.1.9"
  },
  "optionalDependencies": {
    "bufferutil": "^4.0.8"
  }
}

================================================================================
FILE: vite.config.ts
================================================================================
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import tailwindcss from "@tailwindcss/vite";
import path from "path";
import runtimeErrorOverlay from "@replit/vite-plugin-runtime-error-modal";

export default defineConfig({
  plugins: [
    react(),
    runtimeErrorOverlay(),
    tailwindcss(),
    ...(process.env.NODE_ENV !== "production" &&
    process.env.REPL_ID !== undefined
      ? [
          await import("@replit/vite-plugin-cartographer").then((m) =>
            m.cartographer(),
          ),
          await import("@replit/vite-plugin-dev-banner").then((m) =>
            m.devBanner(),
          ),
        ]
      : []),
  ],
  resolve: {
    alias: {
      "@": path.resolve(import.meta.dirname, "client", "src"),
      "@shared": path.resolve(import.meta.dirname, "shared"),
      "@assets": path.resolve(import.meta.dirname, "attached_assets"),
    },
  },
  css: {
    postcss: {
      plugins: [],
    },
  },
  root: path.resolve(import.meta.dirname, "client"),
  build: {
    outDir: path.resolve(import.meta.dirname, "dist/public"),
    emptyOutDir: true,
  },
  server: {
    host: "0.0.0.0",
    allowedHosts: true,
    fs: {
      strict: true,
      deny: ["**/.*"],
    },
  },
});

================================================================================
FILE: replit.md
================================================================================
# Colony Bank HMDA/CRA ETL Automation Tool

## Overview

This is a web-based ETL (Extract, Transform, Load) automation tool for Colony Bank's monthly HMDA (Home Mortgage Disclosure Act) and CRA (Community Reinvestment Act) compliance reporting. The tool processes loan data from multiple source systems (LaserPro, Encompass, and Supplemental exports), validates the data, and generates formatted outputs ready for CRA Wiz import and regulatory submission.

The application reduces what was previously a 100+ hour monthly manual process to under 10 hours with improved accuracy.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Frontend Architecture
- **Framework**: React 18 with TypeScript
- **Build Tool**: Vite with hot module replacement
- **Styling**: Tailwind CSS with shadcn/ui component library
- **State Management**: TanStack React Query for server state
- **Routing**: Wouter (lightweight React router)
- **UI Components**: Radix UI primitives wrapped with shadcn/ui styling

### Backend Architecture
- **Runtime**: Node.js with Express
- **Language**: TypeScript with ES modules
- **API Design**: RESTful endpoints under `/api/` prefix
- **Authentication**: Simple password-based gate (server-validated)
- **Build**: esbuild for production bundling

### Data Processing
- **Excel Processing**: xlsx library for reading/writing Excel and CSV files
- **ETL Engine**: Custom client-side TypeScript engine (`client/src/lib/etl-engine.ts`)
- **Validation**: Schema-based validation with Zod
- **Transformations**: CRA Wiz format conversion with 128-column output specification

### Data Storage
- **Database**: PostgreSQL via Drizzle ORM (configured but primarily uses in-memory storage)
- **Session Storage**: In-memory storage for audit logs during development
- **Schema Location**: `shared/schema.ts` defines the processing audit log table

### Key Design Decisions

1. **Client-Side Processing**: File parsing and ETL logic runs in the browser to avoid server file uploads for sensitive loan data
2. **Multi-Phase Workflow**: 
   - Phase 1: Data Sources (upload LaserPro, Encompass, Supplemental files)
   - Phase 2: ETL Processing (validation, transformation, merging)
   - Phase 3: Review and Export (CRA Wiz format output)
3. **Password Protection**: Server-validated authentication before accessing the tool
4. **Audit Trail**: Processing sessions logged with timestamps, record counts, and validation errors

## External Dependencies

### Core Libraries
- `xlsx`: Excel file reading/writing for .xlsx, .xls, and .csv formats
- `drizzle-orm` + `@neondatabase/serverless`: PostgreSQL ORM (Neon serverless driver)
- `@tanstack/react-query`: Async state management
- `zod`: Runtime type validation and schema definition

### UI Components
- Full shadcn/ui component suite (accordion, dialog, tabs, cards, etc.)
- `lucide-react`: Icon library
- `embla-carousel-react`: Carousel functionality
- `recharts`: Data visualization (via chart component)

### Build & Development
- Vite with React plugin
- Tailwind CSS v4 with `@tailwindcss/vite`
- TypeScript with strict mode
- `drizzle-kit`: Database migrations and schema management

### Replit-Specific Integrations
- `@replit/vite-plugin-runtime-error-modal`: Development error overlay
- `@replit/vite-plugin-cartographer`: Asset mapping (dev only)
- `@replit/vite-plugin-dev-banner`: Development mode indicator
================================================================================
FILE: client/index.html
================================================================================
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Fira+Code:wght@300..700&family=Geist+Mono:wght@100..900&family=Geist:wght@100..900&family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400..700;1,400..700&family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Outfit:wght@100..900&family=Oxanium:wght@200..800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Roboto:ital,wght@0,100..900;1,100..900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&family=Space+Grotesk:wght@300..700&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
================================================================================
FILE: client/src/main.tsx
================================================================================
import { createRoot } from "react-dom/client";
import App from "./App";
import "./index.css";

createRoot(document.getElementById("root")!).render(<App />);

================================================================================
FILE: client/src/index.css
================================================================================
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  
  /* Corporate Blue Theme */
  --color-background: hsl(210 20% 98%);
  --color-foreground: hsl(222 47% 11%);
  
  --color-card: hsl(0 0% 100%);
  --color-card-foreground: hsl(222 47% 11%);
  
  --color-popover: hsl(0 0% 100%);
  --color-popover-foreground: hsl(222 47% 11%);
  
  /* Navy Blue Primary */
  --color-primary: hsl(215 100% 25%);
  --color-primary-foreground: hsl(210 40% 98%);
  
  --color-secondary: hsl(210 40% 96.1%);
  --color-secondary-foreground: hsl(222 47% 11.2%);
  
  --color-muted: hsl(210 40% 96.1%);
  --color-muted-foreground: hsl(215 16% 47%);
  
  --color-accent: hsl(210 40% 96.1%);
  --color-accent-foreground: hsl(222 47% 11.2%);
  
  --color-destructive: hsl(0 84.2% 60.2%);
  --color-destructive-foreground: hsl(210 40% 98%);
  
  --color-border: hsl(214.3 31.8% 91.4%);
  --color-input: hsl(214.3 31.8% 91.4%);
  --color-ring: hsl(215 100% 25%);
  
  --color-chart-1: hsl(215 100% 25%);
  --color-chart-2: hsl(173 58% 39%);
  --color-chart-3: hsl(197 37% 24%);
  --color-chart-4: hsl(43 74% 66%);
  --color-chart-5: hsl(27 87% 67%);
  
  --color-sidebar: hsl(222 47% 11%);
  --color-sidebar-foreground: hsl(210 40% 98%);
  --color-sidebar-primary: hsl(215 100% 25%);
  --color-sidebar-primary-foreground: hsl(0 0% 100%);
  --color-sidebar-accent: hsl(217 33% 17%);
  --color-sidebar-accent-foreground: hsl(210 40% 98%);
  --color-sidebar-border: hsl(217 33% 17%);
  --color-sidebar-ring: hsl(212.7 26.8% 83.9%);
  
  --font-sans: 'Inter', sans-serif;
  --radius: 0.5rem;
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply font-sans antialiased bg-background text-foreground;
  }
}

================================================================================
END OF CODEBASE
================================================================================
